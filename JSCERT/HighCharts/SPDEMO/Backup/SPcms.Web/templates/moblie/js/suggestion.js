(function(a,b){a.ui.define("suggestion",{_data:{listCount:50,isCache:true,isStorage:true,minChars:0,maxChars:1000,useIscroll:true,offset:{x:0,y:0,w:0},confirmClearHistory:true},_create:function(){var e=this,i=+new Date(),h="ui-input-mask-"+i,d=e.data("id","ui-suggestion-"+a.ui.guid()),g=e.root(a(e.data("container"))).attr("autocomplete","off"),f=e.data("formID"),c=g.parent();e.data({inputWidth:g.get(0).offsetWidth,cacheData:{},form:f?a(f):g.closest("form")});if(c.attr("class")!="ui-input-mask"){c=a('<div id="'+h+'" class="ui-input-mask"></div>').appendTo(g.parent()).append(g)}e.data("maskElem",c);e.data("wrapper",a('<div id="'+d+'" class="ui-suggestion"><div class="ui-suggestion-content"><div class="ui-suggestion-scroller"></div></div><div class="ui-suggestion-button"></div></div>').appendTo(c));e._initSuggestionOffset()},_init:function(){var e=this,f=e.root(),d=e.data("form"),c=a.proxy(e._eventHandler,e);e.data("wrapper").on("touchstart",c);d.length&&d.on("submit",c);f.on("focus input",c).parent().on("touchstart",c);a(window).on("ortchange",c);e.data("autoClose")&&a(document).on("tap",c);e.on("destroy",function(){var h=this,g=h.data("maskElem");a(document).off("tap",c);a(window).off("ortchange",c);clearTimeout(h.data("timeId"));clearTimeout(h.data("hideTimer"));g.find("*").off();h.data("iScroll")&&h.data("iScroll").destroy();g.off().remove()})._setSize()},_setup:function(){var c=this;c.data("container",c.root());c._create()},_initSuggestionOffset:function(){var f=this,e,c=f.data("wrapper"),h=f.root(),g=f.data("offset"),d=2*parseInt(c.css("border-left-width")||0);f.data("pos",h.height()+(g.y||0));f.data("realWidth",(f.data("width")||h.width())-d);c.css({position:"absolute",left:g.x||0});return f},_setSize:function(){var d=this,c=d.data("realWidth"),e=d.root().parent().width()-d.data("inputWidth");d.data("wrapper").css("width",c+e);return d},_posAdapt:function(c){var d=this;c?d._setPos().data("timeId",a.later(function(){d._setPos()},200,true)):clearInterval(d.data("timeId"));return d},_setPos:function(){var g=this,f=window,c=g.data("wrapper"),h=g.root(),k=parseFloat(c.height()),e=g.data("offset"),i=parseFloat(g.data("pos")),j=h.offset().top-f.pageYOffset,d=a(f).height()-j;if(g.data("posAdapt")&&j>d){c.css("top",-k-(e.y||0)+"px")}else{c.css("top",i)}return g},_change:function(g){var d=this,f=d._cacheData(g),c=d.data("isCache"),e=d.data("source");return f&&c?d._render(g,f):d._sendRequest(g)},_eventHandler:function(h){var d=this,c=h.type,g=h.target,f=d.data("maskElem").get(0);if(!d.data("status")){return}switch(c){case"focus":d._setSize()._showList()._setPos().trigger("open");break;case"touchstart":case"mousedown":if(!h.formDelete){break}h.preventDefault();case"input":d._showList();break;case"ortchange":d._setSize()._setPos();break;case"submit":d.data("isStorage")&&d._localStorage(d.getValue());case"click":case"tap":if(!(f.compareDocumentPosition(g)&16)){d.hide()}break}},_showList:function(){var c=this,e=c.getValue(),d=c._localStorage();if(e!==""&&(e.length<parseFloat(c.data("minChars"))||e.length>parseFloat(c.data("maxChars")))){return c}return e?c._change(e):d?c._render(null,{s:d.split(encodeURIComponent(","))}):c.hide()},_bindSuggestionListEvent:function(){var c=this,d=c.root();c.data("wrapper").find(".ui-suggestion-result").on("tap",function(h){var g=h.target,f=this;setTimeout(function(){if(g&&g.className=="ui-suggestion-plus"){d.val(g.getAttribute("data-item")).trigger("input")}else{c._select(f)._submit()}},400)}).highlight("ui-suggestion-result-highlight");return c},_bindCloseEvent:function(){var c=this,d=c.data("wrapper");d.find("span:first-child").on("click",function(){a.later(function(){c.clearHistory()},a.os.android?200:0)});d.find("span:last-child").on("click",function(){c.hide().leaveInput().trigger("close")});return c},_sendRequest:function(g){var f=this,d=f.data("source"),h=f.data("param"),c="suggestion_"+(+new Date()),e=f.data("sendRequest");if(a.isFunction(e)){e(g,function(i){f._render(g,i)._cacheData(g,i)})}else{if(g){d+=(d.indexOf("?")===-1?"?":"")+"&wd="+encodeURIComponent(g);d.indexOf("&cb=")===-1&&(d+="&cb="+c);h&&(d+="&"+h);window[c]=function(i){f._render(g,i)._cacheData(g,i);a('[src="'+d+'"]').remove();delete window[c]};a.ajax({url:d,dataType:"jsonp"})}}return f},getValue:function(){return a.trim(this.root().val())},_render:function(k,h){var l=this,i,f=l.data("wrapper"),e=f.find(".ui-suggestion-content"),c=f.find(".ui-suggestion-button"),d=l.data("renderList"),m=l.data("renderEvent"),g='<span style="display:none;"></span><span>\u5173\u95ed</span>';k===null&&(g="<span>\u6e05\u9664\u5386\u53f2\u8bb0\u5f55</span><span>\u5173\u95ed</span>");i=d?d.apply(l,[k,h]):l._renderList(k,h);if(i){e.find("*").off();e.find(".ui-suggestion-scroller").html(i);c.find("*").off();c.html(g);m?m.apply(l):l._bindSuggestionListEvent();l._bindCloseEvent()._show();if(l.data("useIscroll")){h.s.length>=2?e.css("height",l.data("height")||66):e.css("height",38);var j=(l.data("iScroll")||l.data("iScroll",new iScroll(e.get(0),{topOffset:0,hScroll:false,vScrollbar:false,hScrollbar:false})));j.scrollTo(0,0);j.refresh()}else{e.on("touchstart",function(n){n.preventDefault()})}}else{l.hide()}return l},_renderList:function(i,h){var g=this,c=g.data("listCount"),f=g.data("usePlus"),e="<ul>",d=h.s;if(!h||!d||!d.length){this.hide();return}d=d.slice(0,c);i=this._htmlEncode(i)||null;a.each(d,function(j,k){k=g._htmlEncode(k);var l=a.trim(k).replace(i,"<span>"+i+"</span>");if(f){l+='<div class="ui-suggestion-plus" data-item="'+k+'"></div>'}e+='<li><div class="ui-suggestion-result">'+l+"</div></li>"});return e+"</ul>"},_htmlEncode:function(c){return a("<div></div>").text(c).html()},_submit:function(){var c=this,d=c.root().val();c.trigger("submit");if(!c.data("submit")&&!(c._callbacks&&c._callbacks.submit)){window.location="http://www.baidu.com/s?wd="+encodeURIComponent(d)}return c},_select:function(e){var d=this,c=e.textContent;d.root().val(c);d.data("isStorage")&&d._localStorage(c);return d.trigger("select",e).hide()},_cacheData:function(c,e){var d=this;if(d.data("isCache")){return e!==b?d.data("cacheData")[c]=e:d.data("cacheData")[c]}},_localStorage:function(h){var f=this,d,j,g,c=f.data("shareName"),k=f.data("isSharing")?c?c+"-SUG-Sharing-History":"SUG-Sharing-History":f.data("id");try{if(h===null){window.localStorage[k]=""}else{if(h!==b){j=window.localStorage[k];g=j?j.split(encodeURIComponent(",")):[];if(!~a.inArray(h,g)){g.unshift(h);window.localStorage[k]=g.join(encodeURIComponent(","))}}}d=window.localStorage[k]}catch(i){}return d},_show:function(){var c=this;if(c.data("hideTimer")){clearTimeout(c.data("hideTimer"));c.data("hideTimer",null)}c.data("wrapper").css("display","block");c.data("posAdapt")&&c._posAdapt(1);return c.trigger("show")},hide:function(){var c=this;c.data("hideTimer",a.later(function(){c.data("wrapper").css("display","none");c.data("hideTimer",null)},200));return c._posAdapt(0).trigger("hide")},clearHistory:function(){var d=this,c=function(){d._localStorage(null);d.hide()};d.data("confirmClearHistory")?window.confirm("\u6e05\u9664\u5168\u90e8\u67e5\u8be2\u5386\u53f2\u8bb0\u5f55\uff1f")&&c():c()},history:function(c){return this._localStorage(c)},focusInput:function(){this.root().get(0).focus();return this},leaveInput:function(){this.root().get(0).blur();return this}})})(Zepto);